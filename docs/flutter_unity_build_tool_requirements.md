# Flutter + Unity 打包工具需求文档

## 背景与目标
- 面向团队内部的网页工具，用于顺序执行 Unity 导出与 Flutter APK 打包并提供下载能力。
- 工具引导用户依次完成 Unity 分支选择与更新、Unity 导出 Flutter、Flutter 分支选择与拉取、Flutter 打包四个阶段。
- 全局互斥锁保证任意时刻只有一个任务在执行；其他访问者仅能查看当前任务进度与历史记录。
- 所有生成的 APK 必须保存，使用时间戳命名并展示触发人与来源分支等元数据，便于追踪与统计。

## 用户角色
- **普通使用者**：登录后发起或查看打包任务、下载历史 APK。
- **管理员（可选）**：配置仓库与执行环境、管理清理策略、维护统计报表与权限。

## 功能需求
- **分支与仓库管理**
  - 接入 Unity 与 Flutter Git 仓库，展示远程分支列表及最近提交摘要。
  - 支持配置仓库地址、认证方式与可选镜像源。
- **自定义参数支持**
  - Unity 导出与 Flutter build 阶段可输入额外命令行参数，支持预设模板或历史参数快捷选择。
  - 参数需记录到任务日志与历史记录中，便于复现。
- **Unity 阶段执行**
  - 用户选择 Unity 分支后触发拉取更新，显示进度与耗时。
  - 执行 Unity 导出 Flutter 方法，实时输出日志；失败时提供重试建议。
- **Flutter 阶段执行**
  - Unity 导出成功后方可继续；选择 Flutter 分支并拉取更新。
  - 执行 Flutter build 生成 APK，实时展示日志与阶段耗时。
- **任务状态管理**
  - 全局锁控制单任务执行；提供排队机制与可视化状态。
  - 展示任务时间线、阶段耗时、当前状态（等待、进行中、成功、失败）。
- **产物管理与下载**
  - APK 以 `yyyyMMdd_HHmmss_<taskId>.apk` 命名保存，持久存储。
  - 列表展示每次任务的生成时间、来源分支、参数、触发人、文件大小、下载链接。
- **清理策略**
  - 后台可配置保留策略（按天数、数量或两者组合）。
  - 支持手动归档、删除或导出历史产物；删除需具备权限控制与操作审计。
- **统计分析**
  - 仪表盘提供核心指标：任务成功率、平均耗时、按分支/触发人/日期聚合的打包次数。
  - 支持导出统计报表（CSV/JSON）或提供 API 供外部系统使用。
- **日志系统**
  - Unity 与 Flutter 命令输出实时流式展示，并持久化保存；支持按任务检索。
  - 错误日志需可下载或复制，便于排查。
- **通知机制（可选）**
  - 任务完成、失败或排队时可通过邮件/IM/浏览器通知用户。
- **权限与审计**
  - 提供基础登录或 Token 校验，区分普通与管理员权限。
  - 记录所有关键操作（触发任务、修改配置、删除产物）的审计日志。

## 非功能需求
- 前后端分离：建议使用 React/Vue 等前端框架；后端可选 Node.js/Python/Go 实现调度与命令执行。
- 命令执行需在受控服务器端完成，统一管理 Unity Editor、Flutter SDK 路径与凭证。
- UI 需具备响应式设计，至少支持桌面端与基础移动端查看。
- 目前仅支持单环境，但架构需预留扩展至多环境的能力。
- 保证任务记录不可覆盖或丢失，失败任务允许重新发起但新建独立记录。
- 系统需具备基础容错能力，如任务超时、进程崩溃后的恢复机制。

## 页面结构建议
- **仪表盘**：展示当前任务状态、排队情况、关键统计指标、历史产物列表。
- **新建任务向导**：分步骤完成 Unity 分支与参数选择、更新与导出、Flutter 分支与参数选择、打包。
- **任务详情页**：展示任务时间线、实时日志、命令参数、产物信息、失败原因。
- **设置管理**：配置仓库路径、SDK/Editor 路径、自定义参数模板、清理策略、通知方式、权限分配。

## 数据模型（示例）
- **Task**：`id`、`status`、`initiator`、`unityBranch`、`flutterBranch`、`unityArgs`、`flutterArgs`、`createdAt`、`completedAt`、`stageDurations`、`logPaths`、`artifactId`、`metrics`。
- **Artifact**：`id`、`taskId`、`filePath`、`fileSize`、`createdAt`、`downloadUrl`、`checksum`、`archived`。
- **Statistics**：分支/日期/触发人维度的成功次数、失败次数、平均耗时、最近一次运行时间。
- **RepoConfig**：仓库地址、认证信息、镜像设置、默认分支、拉取策略。
- **CleanupPolicy**：保留天数、保留数量、归档目录、策略生效时间。
- **User**：`id`、`name`、`role`、`contact`、`lastLogin`。
- **AuditLog**：`id`、`userId`、`action`、`payload`、`timestamp`、`result`。

## 工作流描述
1. 用户登录访问网页，若无运行中的任务，可创建新任务；否则查看当前任务进度。
2. 选择 Unity 仓库及分支，按需填写自定义参数并触发更新；系统显示同步进度与日志。
3. 执行 Unity 导出 Flutter，实时展示日志；成功后推进到 Flutter 阶段。
4. 选择 Flutter 分支与自定义参数，拉取更新并执行 `flutter build apk`。
5. 生成 APK 后保存到产物目录，按命名规则记录；写入任务与产物数据。
6. 任务完成后可触发通知；释放全局锁，允许下一任务执行。
7. 定期按清理策略归档或删除历史 APK，同时更新统计数据。

## 开放问题
- 自定义参数是否需要预设模板管理与校验规则？
- 清理策略的默认阈值及归档形式（本地压缩、转移对象存储等）。
- 统计报表是否需图表化展示或集成外部 BI 工具？
- 是否需要开放 API 供其他系统自动触发或查询任务？

## 下一步建议
1. 明确 Unity 与 Flutter 命令行参数需求，整理常用模板与校验方案。
2. 细化清理策略触发机制（定时任务、手动触发或基于存储占用）。
3. 设计系统架构图、组件交互图以及数据库/存储方案。
4. 定义前后端 API 契约、权限模型与审计日志规范。
5. 规划统计指标的展示形式与报表导出流程。
